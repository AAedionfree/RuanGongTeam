<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<title></title>
		<script src="js/mui.min.js"></script>
		<script src="js/main.js"></script>
		<script src="js/fun.js"></script>
		<link href="css/mui.min.css" rel="stylesheet" />
		<script type="text/javascript" charset="utf-8">

		</script>
		</script>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta http-equiv="X-UA-Compatible" content="ie=edge" />
		<title>Bar with Custom DataLabels</title>

		<link href="../../assets/styles.css" rel="stylesheet" />

		<style>
			#chart {
				max-width: 650px;
				margin: 35px auto;
			}
		</style>

		<script>
			window.Promise ||
				document.write(
					'<script src="https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js"><\/script>'
				)
			window.Promise ||
				document.write(
					'<script src="https://cdn.jsdelivr.net/npm/eligrey-classlist-js-polyfill@1.2.20171210/classList.min.js"><\/script>'
				)
			window.Promise ||
				document.write(
					'<script src="https://cdn.jsdelivr.net/npm/findindex_polyfill_mdn"><\/script>'
				)
		</script>


		<script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>



	</head>

	<body>
		<div id="chart"></div>
		<script>
			function draw(equipments, equipmentsCategories, colors) {
				var options = {
					series: [{
						data: equipments
					}],
					chart: {
						type: 'bar',
						height: 380
					},
					plotOptions: {
						bar: {
							barHeight: '100%',
							distributed: true,
							horizontal: true,
							dataLabels: {
								position: 'bottom'
							},
						}
					},
					colors: colors,
					dataLabels: {
						enabled: true,
						textAnchor: 'start',
						style: {
							colors: ['#fff']
						},
						formatter: function(val, opt) {
							return opt.w.globals.labels[opt.dataPointIndex] + ":  " + val
						},
						offsetX: 0,
						dropShadow: {
							enabled: true
						}
					},
					stroke: {
						width: 1,
						colors: ['#fff']
					},
					xaxis: {
						categories: equipmentsCategories,
					},
					yaxis: {
						labels: {
							show: false
						}
					},
					title: {
						text: 'Your Equipment Distribution',
						align: 'center',
						floating: true
					},
					subtitle: {
						text: 'Category Names as DataLabels inside bars',
						align: 'center',
					},
					tooltip: {
						theme: 'dark',
						x: {
							show: false
						},
						y: {
							title: {
								formatter: function() {
									return ''
								}
							}
						}
					}
				};

				var chart = new ApexCharts(document.querySelector("#chart"), options);
				chart.render();
			}
		</script>
		<script>
			mui.init();
			var t = 0
			var flagMyEquipment = 0
			var flagTempEquipment = 0
			var equipments = new Array()
			var equipmentsCategories = new Array()
			var colors = new Array()
			var colorsList = ['#33b2df', '#546E7A', '#d4526e', '#13d8aa', '#A5978B', '#2b908f', '#f9a3a4', '#90ee7e',
				'#f48024', '#69d2e7'
			]
			mui.plusReady(function() {
				var self = plus.webview.currentWebview();
				mui('body').on('click', 'a', function() {
					document.location.href = this.href;
				});
				mui.plusReady(function() {
					var self = plus.webview.currentWebview();
					user = self.user;
				});
				user = self.user;
				var request_url = localStorage.getItem('request_url');
				var getMyEquipmentsUrl = request_url + 'devManagerAccount?managerAccount=' + user.userAccount
				var getTempEquipmentsUrl = request_url + 'devDevUserAccount?userAccount=' + user.userAccount;
				mui.ajax({
					type: 'GET',
					url: getMyEquipmentsUrl,
					dataType: "json",
					success: function(data) {
						if ((data.data != null) && (user.userAuthority < 3)) {
							for (var i = 0; i < data.data.length; i++) {
								let item = data.data[i].devName
								if (equipmentsCategories.indexOf(item) == -1) {
									equipmentsCategories[t] = item
									equipments[t] = 1
									colors[t] = colorsList[t]
									t++
								} else {
									equipments[equipmentsCategories.indexOf(item)]++
								}
							}
						}
						console.log("arrive")
						flagTempEquipment = 1
					},
					error: function(xhr, type, errorThrown) {
						mui.toast("服务器内部出错！");
					}
				});
				mui.ajax({
					type: 'GET',
					url: getTempEquipmentsUrl,
					dataType: "json",
					success: function(data) {
						if ((data.data != null) && (user.userAuthority < 3)) {
							for (var i = 0; i < data.data.length; i++) {
								let item = data.data[i].devName
								if (equipmentsCategories.indexOf(item) == -1) {
									equipmentsCategories[t] = item
									equipments[t] = 1
									colors[t] = colorsList[t]
									t++
								} else {
									equipments[equipmentsCategories.indexOf(item)]++
								}
							}
						}
						console.log("arrive")
						flagTempEquipment = 1
					},
					error: function(xhr, type, errorThrown) {
						mui.toast("服务器内部出错！");
					}
				});
			})

			function sleep(interval) {
				return new Promise(resolve => {
					setTimeout(resolve, interval);
				})
			}

			async function oneAsync(equipments, equipmentsCategories) {
				await sleep(500);
				draw(equipments, equipmentsCategories)
			}

			oneAsync(equipments, equipmentsCategories, colors)
		</script>


	</body>
</html>
